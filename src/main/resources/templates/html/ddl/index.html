<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ddl语法转Java代码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 样式引入 -->
    <link rel="stylesheet" th:href="@{/utils/elementui/theme-chalk/index.css}">
    <link rel="stylesheet" th:href="@{/css/ddl/index.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/index.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/theme/eclipse.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/hint/show-hint.css}">
    <link rel="stylesheet" th:href="@{/utils/icon/iconfont.css}">

</head>
<body>

<div id="app" v-cloak>
    <el-row :gutter="20" style="height: calc(100vh - 40px);">
        <el-col :span="12" style="height: 100%;">
            <div class="title">DDL建表语句</div>
            <div class="ddl-code-wrapper">
                <textarea id="code" v-model="ddlText"></textarea>
            </div>
            <div class="button-div">
                <el-button type="success" round @click="drawer = true">配置项</el-button>
                <el-button type="primary" round @click="onSubmit">生成代码</el-button>
            </div>
        </el-col>
        <el-col :span="12" style="height: 100%;">
            <div class="title">Java代码</div>
            <div class="java-code-wrapper">
                <button class="copy-btn" id="copyBtn">
                    <i class="iconfont icon-copy"></i> 复制
                </button>
                <textarea id="javaCode" v-model="javaCode"></textarea>
            </div>
        </el-col>
    </el-row>

    <el-drawer
            title="配置项信息"
            size="40%"
            :visible.sync="drawer"
            :direction="direction">
        <el-form ref="form" :model="form" label-width="150px">
            <el-row :gutter="20">
                <el-col :span="6">
                    <el-form-item label="包路径">
                        <el-input v-model="form.packageUrl"></el-input>
                    </el-form-item>
                    <el-form-item label="是否需要注释：">
                        <el-radio-group v-model="form.openComments">
                            <el-radio label="是"></el-radio>
                            <el-radio label="否"></el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="代码">
                        <el-select v-model="form.dbType" @change="codeChange" placeholder="请选择生成的代码类型">
                            <el-option label="entity" value="entity"></el-option>
                            <el-option label="mapper.java" value="mapper.java"></el-option>
                            <el-option label="mapper.xml" value="mapper.xml"></el-option>
                            <el-option label="service" value="service"></el-option>
                            <el-option label="serviceImpl" value="serviceImpl"></el-option>
                            <el-option label="controller" value="controller"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="是否开启Swagger：">
                        <el-radio-group v-model="form.openComments">
                            <el-radio label="是"></el-radio>
                            <el-radio label="否"></el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="中间件">
                        <el-select v-model="form.dbType" placeholder="请选择生成的代码类型">
                            <el-option label="jpa" value="jpa"></el-option>
                            <el-option label="Mybatis" value="Mybatis"></el-option>
                            <el-option label="Mybatis-Plus" value="Mybatis-Plus"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">

                </el-col>
            </el-row>

        </el-form>
    </el-drawer>
</div>

<!-- JS 引入 -->
<script th:src="@{/utils/jQuery3.6.0.min.js}"></script>
<script th:src="@{/utils/vue2.7.16.min.js}"></script>
<script th:src="@{/utils/elementui/ele-lib-index.js}"></script>
<script th:src="@{/utils/codemirror/index.js}"></script>
<script th:src="@{/utils/codemirror/mode/sql.js}"></script>
<script th:src="@{/utils/codemirror/mode/clike.js}"></script>
<script th:src="@{/utils/codemirror/mode/xml.js}"></script>
<script th:src="@{/utils/codemirror/hint/show-hint.js}"></script>
<script th:src="@{/utils/codemirror/hint/sql-hint.js}"></script>

<script>
    let editor;

    let javaCodeEditor;

    new Vue({
        el: '#app',
        data() {
            return {
                ddlText: '',
                javaCode: '',
                drawer: false,
                direction: 'ttb',
                codeEditMode: 'text/x-java',
                form: {
                    name: '',
                    region: '',
                    date1: '',
                    date2: '',
                    delivery: false,
                    type: [],
                    resource: '',
                    desc: ''
                }
            };
        },
        mounted() {
            // 初始化ddl编辑插件
            this.ddlEditorInit();
            // 初始化java编辑插件
            this.javaCodeEditorInit();
        },
        methods: {
            onSubmit() {
                console.log('submit!');
            },

            codeChange(val) {
                if (val.includes("xml")) {
                    this.codeEditMode = "application/xml";
                } else {
                    this.codeEditMode = "text/x-java";
                }
                this.javaCodeEditorInit();
            },
            javaCodeEditorInit() {

                // 销毁已有实例（避免重复）
                if (javaCodeEditor) {
                    javaCodeEditor.toTextArea();
                }

                // 初始化 CodeMirror
                javaCodeEditor = CodeMirror.fromTextArea(document.getElementById("javaCode"), {
                    mode: this.codeEditMode,
                    theme: "eclipse",
                    lineNumbers: true,
                    readOnly: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete"
                    }
                });

                // 让编辑器高度自适应父容器
                editor.setSize("100%", "100%");

                // 输入时自动触发 SQL 提示
                javaCodeEditor.on("inputRead", function (cm, change) {
                    if (change.text[0].match(/[\w\.]/)) {
                        cm.showHint({hint: CodeMirror.hint.sql});
                    }
                });
            },
            ddlEditorInit() {
                // 初始化 CodeMirror
                editor = CodeMirror.fromTextArea(document.getElementById("code"), {
                    mode: "text/x-sql",
                    theme: "eclipse",
                    lineNumbers: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete"
                    }
                });

                // 让编辑器高度自适应父容器
                // editor.setSize("100%", "70%");

                // 输入时自动触发 SQL 提示
                editor.on("inputRead", function (cm, change) {
                    if (change.text[0].match(/[\w\.]/)) {
                        cm.showHint({hint: CodeMirror.hint.sql});
                    }
                });
            }
        }
    });
</script>
</body>
</html>
