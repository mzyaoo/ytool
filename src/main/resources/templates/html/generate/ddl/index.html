<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ddl语法转Java代码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 样式引入 -->
    <link rel="stylesheet" th:href="@{/utils/elementui/theme-chalk/index.css}">
    <link rel="stylesheet" th:href="@{/css/ddl/index.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/index.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/theme/eclipse.css}">
    <link rel="stylesheet" th:href="@{/utils/codemirror/hint/show-hint.css}">
    <link rel="stylesheet" th:href="@{/utils/icon/iconfont.css}">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body>


<div id="app" v-cloak>
    <el-row type="flex" justify="center" align="middle" style="background-color: #fff; padding: 40px 20px;">
        <el-col :xs="24" :sm="24" :md="14">
            <div>
                <h1 style="font-size: 36px; font-weight: bold; margin-bottom: 20px;text-align: center">在线 Java
                    代码生成器</h1>
                <p style="font-size: 16px; color: #666; line-height: 1.8;text-align: center">
                    SQL转JAVA | SQL转JPA | SQL转Mybatis | Mybatis在线生成器<br>
                    SQL转Java | JPA | Mybatis实现类模板代码生成平台<br>
                    通过建表SQL语句生成 JPA / JdbcTemplate / Mybatis / MybatisPlus 等相关代码
                </p>
                <div style="margin-top: 30px;display: flex;justify-content: center">
                    <el-button type="danger" size="medium" @click="generateHandler">立即生成</el-button>
                </div>
            </div>
        </el-col>
        <el-col :xs="24" :sm="24" :md="8" style="text-align: center; margin-top: 20px;">
            <img th:src="@{/img/code.png}" alt="代码生成器插图"
                 style="max-width: 40%; height: auto;">
        </el-col>
    </el-row>
    <div style="margin: 0 40px">
        <el-row :gutter="20" style="height: calc(100vh - 40px);">
            <el-col :span="12" style="height: 100%;">
                <div class="title">DDL建表语句</div>
                <div class="ddl-code-wrapper">
                    <textarea id="code" v-model="ddlText"></textarea>
                </div>
            </el-col>
            <el-col :span="12" style="height: 100%;">
                <div class="title">生成结果</div>
                <el-row :gutter="20" style="height: calc(100vh - 40px);">
                    <el-col :span="10" style="height: 100%; overflow: auto">
                        <!-- 文件树容器 -->
                        <ul>
                            <template v-for="node in fileTree">
                                <li>
                                    <div :class="{ selected: node.selected }" @click="toggle(node)">
                                        <i :class="node.type === 'folder'
                            ? (node.open ? 'fa-solid fa-folder-open' : 'fa-solid fa-folder')
                            : 'fa-regular fa-file'"></i>
                                        {{ node.label }}
                                    </div>
                                    <ul v-if="node.children && node.children.length" v-show="node.open">
                                        <template v-for="child in node.children">
                                            <tree-branch :node="child" :key="child.id"
                                                         @file-click="handleFileClick"></tree-branch>
                                        </template>
                                    </ul>
                                </li>
                            </template>
                        </ul>
                    </el-col>
                    <el-col :span="14" style="height: 100%;">
                        <div class="java-code-wrapper">
                            <button class="copy-btn" id="copyBtn" @click="copyCode">
                                <i class="iconfont icon-copy"></i> 复制
                            </button>
                            <textarea id="javaCode" v-model="javaCode" readonly></textarea>
                        </div>
                    </el-col>
                </el-row>
            </el-col>
        </el-row>
    </div>


    <el-drawer
            title="配置项信息"
            size="40%"
            :visible.sync="drawer"
            :direction="direction">
        <el-form ref="form" :model="form" label-width="150px">
            <el-row :gutter="20">
                <el-col :span="6">
                    <el-form-item label="包路径">
                        <el-input v-model="form.packageUrl"></el-input>
                    </el-form-item>
                    <el-form-item label="是否需要注释：">
                        <el-radio-group v-model="form.openComments">
                            <el-radio label="是"></el-radio>
                            <el-radio label="否"></el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="代码">
                        <el-select v-model="form.dbType" @change="codeChange" placeholder="请选择生成的代码类型">
                            <el-option label="entity" value="entity"></el-option>
                            <el-option label="mapper.java" value="mapper.java"></el-option>
                            <el-option label="mapper.xml" value="mapper.xml"></el-option>
                            <el-option label="service" value="service"></el-option>
                            <el-option label="serviceImpl" value="serviceImpl"></el-option>
                            <el-option label="controller" value="controller"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="是否开启Swagger：">
                        <el-radio-group v-model="form.openComments">
                            <el-radio label="是"></el-radio>
                            <el-radio label="否"></el-radio>
                        </el-radio-group>
                    </el-form-item>
                </el-col>
                <el-col :span="6">
                    <el-form-item label="中间件">
                        <el-select v-model="form.dbType" placeholder="请选择生成的代码类型">
                            <el-option label="jpa" value="jpa"></el-option>
                            <el-option label="Mybatis" value="Mybatis"></el-option>
                            <el-option label="Mybatis-Plus" value="Mybatis-Plus"></el-option>
                        </el-select>
                    </el-form-item>
                </el-col>
                <el-col :span="6">

                </el-col>
            </el-row>

        </el-form>
    </el-drawer>
</div>

<!-- JS 引入 -->
<script th:src="@{/utils/jQuery3.6.0.min.js}"></script>
<script th:src="@{/utils/vue2.7.16.min.js}"></script>
<script th:src="@{/utils/elementui/ele-lib-index.js}"></script>
<script th:src="@{/utils/codemirror/index.js}"></script>
<script th:src="@{/utils/codemirror/mode/sql.js}"></script>
<script th:src="@{/utils/codemirror/mode/clike.js}"></script>
<script th:src="@{/utils/codemirror/mode/xml.js}"></script>
<script th:src="@{/utils/codemirror/hint/show-hint.js}"></script>
<script th:src="@{/utils/codemirror/hint/sql-hint.js}"></script>

<script>
    // 手动注册 tree-branch，不作为单文件组件，只是渲染子节点（非递归组件）
    Vue.component('tree-branch', {
        props: ['node'],
        methods: {
            toggle(node) {
                if (node.type === 'folder') {
                    node.open = !node.open;
                } else {
                    this.$emit('file-click', node);
                }
            }
        },
        template: `
            <li>
                <div :class="{ selected: node.selected }" @click="toggle(node)">
                    <i :class="node.type === 'folder'
                        ? (node.open ? 'fa-solid fa-folder-open' : 'fa-solid fa-folder')
                        : 'fa-regular fa-file'"></i>
                    {{ node.label }}
                </div>
                <ul v-if="node.children && node.children.length" v-show="node.open">
                    <tree-branch
                        v-for="child in node.children"
                        :key="child.id"
                        :node="child"
                        @file-click="$emit('file-click', $event)"
                    ></tree-branch>
                </ul>
            </li>
        `
    });
</script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                ddlEditor: null,
                javaCodeEditor: null,
                ddlText: '',
                javaCode: '',
                drawer: false,
                direction: 'ttb',
                codeEditMode: 'text/x-java',
                form: {
                    name: '',
                    region: '',
                    date1: '',
                    date2: '',
                    delivery: false,
                    type: [],
                    resource: '',
                    desc: ''
                },
                fileTree: [],
            };
        },
        mounted() {
            // 初始化ddl编辑插件
            this.ddlEditorInit();
            // 初始化java编辑插件
            this.javaCodeEditorInit();
        },
        methods: {
            onSubmit() {
                console.log('submit!');
            },
            codeChange(val) {
                if (val.includes("xml")) {
                    this.codeEditMode = "application/xml";
                } else {
                    this.codeEditMode = "text/x-java";
                }
                this.javaCodeEditorInit();
            },
            javaCodeEditorInit() {

                // 销毁已有实例（避免重复）
                if (this.javaCodeEditor) {
                    this.javaCodeEditor.toTextArea();
                }

                // 初始化 CodeMirror
                this.javaCodeEditor = CodeMirror.fromTextArea(document.getElementById("javaCode"), {
                    mode: this.codeEditMode,
                    theme: "eclipse",
                    lineNumbers: true,
                    readOnly: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete"
                    }
                });

                // 让编辑器高度自适应父容器
                this.javaCodeEditor.setSize("100%", "100%");

                // 输入时自动触发 SQL 提示
                this.javaCodeEditor.on("inputRead", function (cm, change) {
                    if (change.text[0].match(/[\w\.]/)) {
                        cm.showHint({hint: CodeMirror.hint.sql});
                    }
                });
            },
            ddlEditorInit() {
                // 初始化 CodeMirror
                this.ddlEditor = CodeMirror.fromTextArea(document.getElementById("code"), {
                    mode: "text/x-sql",
                    theme: "eclipse",
                    lineNumbers: true,
                    extraKeys: {
                        "Ctrl-Space": "autocomplete"
                    }
                });

                // 让编辑器高度自适应父容器
                this.ddlEditor.setSize("100%", "100%");

                // 输入时自动触发 SQL 提示
                this.ddlEditor.on("inputRead", function (cm, change) {
                    if (change.text[0].match(/[\w\.]/)) {
                        cm.showHint({hint: CodeMirror.hint.sql});
                    }
                });
            },
            toggle(node) {
                if (node.type === 'folder') {
                    node.open = !node.open;
                } else {
                    this.handleFileClick(node);
                }
            },
            handleFileClick(fileNode) {
                this.clearSelection(this.fileTree);
                fileNode.selected = true;
                this.javaCode = fileNode.content;

                const ext = fileNode.label.split('.').pop();
                const mode = ext === 'xml' ? 'application/xml' : 'text/x-java';
                this.javaCodeEditor.setOption("mode", mode);
                this.javaCodeEditor.setValue(fileNode.content);
            },
            clearSelection(nodes) {
                nodes.forEach(node => {
                    node.selected = false;
                    if (node.children) this.clearSelection(node.children);
                });
            },
            buildTree(data) {
                const tree = [];
                const map = {};

                data.forEach(file => {
                    const parts = file.path.split('/');
                    let current = tree;

                    parts.forEach((part, index) => {
                        const pathSoFar = parts.slice(0, index + 1).join('/');
                        if (!map[pathSoFar]) {
                            const isFile = index === parts.length - 1;
                            const node = {
                                id: pathSoFar,
                                label: part,
                                type: isFile ? 'file' : 'folder',
                                open: !isFile,
                                selected: false,
                                children: [],
                                ...(isFile ? {content: file.content} : {})
                            };
                            map[pathSoFar] = node;
                            current.push(node);
                        }
                        current = map[pathSoFar].children;
                    });
                });

                return tree;
            },
            generateHandler(){
                // 模拟后端数据
                const response = [
                    { path: 'com/example/entity/User.java', content: '// User.java content\npublic class User {}' },
                    { path: 'com/example/mapper/UserMapper.java', content: '// Mapper.java content\ninterface UserMapper {}' },
                    { path: 'com/example/mapper/UserMapper.xml', content: '<!-- XML content -->\n<mapper></mapper>' }
                ];
                this.fileTree = this.buildTree(response);
            },
            copyCode() {

            }
        }
    });
</script>
</body>
</html>
