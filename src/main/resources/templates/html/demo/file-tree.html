<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自定义文件树示例</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .left-panel {
            width: 30%;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }
        .right-panel {
            width: 70%;
            padding: 10px;
        }
        ul {
            list-style: none;
            padding-left: 20px;
        }
        li > div {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 4px 0;
        }
        i {
            margin-right: 8px;
        }
        .selected {
            background-color: #eef;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="left-panel">
        <ul>
            <tree-node
                    v-for="node in fileTree"
                    :key="node.id"
                    :node="node"
                    @file-click="handleFileClick"
            />
        </ul>
    </div>
    <div class="right-panel">
        <textarea id="javaCode" v-model="javaCode"></textarea>
    </div>
</div>

<!-- Vue -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/xml/xml.min.js"></script>

<script>
    Vue.component('tree-node', {
        props: ['node'],
        methods: {
            toggle() {
                if (this.node.type === 'folder') {
                    this.node.open = !this.node.open;
                } else {
                    this.$emit('file-click', this.node);
                }
            }
        },
        template: `
    <li>
      <div @click="toggle" :class="{ selected: node.selected }">
        <i :class="node.type === 'folder'
            ? (node.open ? 'fa-solid fa-folder-open' : 'fa-solid fa-folder')
            : 'fa-regular fa-file'"></i>
        {{ node.label }}
      </div>
      <ul v-if="node.children && node.children.length" v-show="node.open">
        <tree-node
          v-for="child in node.children"
          :key="child.id"
          :node="child"
          @file-click="$emit('file-click', $event)"
        />
      </ul>
    </li>
  `
    });

    new Vue({
        el: '#app',
        data() {
            return {
                fileTree: [],
                javaCode: '',
                editor: null
            };
        },
        mounted() {
            this.initEditor();
            // 模拟后端返回数据
            const response = [
                { path: 'com/example/entity/User.java', content: '// User.java content\npublic class User {}' },
                { path: 'com/example/mapper/UserMapper.java', content: '// Mapper.java content\ninterface UserMapper {}' },
                { path: 'com/example/mapper/UserMapper.xml', content: '<!-- XML content -->\n<mapper></mapper>' }
            ];
            this.fileTree = this.buildTree(response);
        },
        methods: {
            initEditor() {
                this.editor = CodeMirror.fromTextArea(document.getElementById("javaCode"), {
                    mode: "text/x-java",
                    theme: "default",
                    lineNumbers: true,
                    readOnly: true
                });
                this.editor.setSize("100%", "100%");
            },
            handleFileClick(fileNode) {
                this.clearSelection(this.fileTree);
                fileNode.selected = true;
                this.javaCode = fileNode.content;

                const ext = fileNode.label.split('.').pop();
                const mode = ext === 'xml' ? 'application/xml' : 'text/x-java';
                this.editor.setOption("mode", mode);
                this.editor.setValue(fileNode.content);
            },
            clearSelection(nodes) {
                nodes.forEach(node => {
                    node.selected = false;
                    if (node.children) this.clearSelection(node.children);
                });
            },
            buildTree(data) {
                const tree = [];
                const map = {};

                data.forEach(file => {
                    const parts = file.path.split('/');
                    let current = tree;

                    parts.forEach((part, index) => {
                        const pathSoFar = parts.slice(0, index + 1).join('/');
                        if (!map[pathSoFar]) {
                            const isFile = index === parts.length - 1;
                            const node = {
                                id: pathSoFar,
                                label: part,
                                type: isFile ? 'file' : 'folder',
                                open: false,
                                selected: false,
                                children: [],
                                ...(isFile ? { content: file.content } : {})
                            };
                            map[pathSoFar] = node;
                            current.push(node);
                        }
                        current = map[pathSoFar].children;
                    });
                });

                return tree;
            }
        }
    });
</script>
</body>
</html>
