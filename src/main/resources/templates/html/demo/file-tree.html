<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>自定义文件树示例</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .left-panel {
            width: 30%;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }
        .right-panel {
            width: 70%;
            padding: 10px;
        }
        ul {
            list-style: none;
            padding-left: 20px;
        }
        li > div {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 4px 0;
        }
        i {
            margin-right: 8px;
        }
        .selected {
            background-color: #eef;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="left-panel">
        <ul>
            <template v-for="node in fileTree">
                <li>
                    <div :class="{ selected: node.selected }" @click="toggle(node)">
                        <i :class="node.type === 'folder'
                            ? (node.open ? 'fa-solid fa-folder-open' : 'fa-solid fa-folder')
                            : 'fa-regular fa-file'"></i>
                        {{ node.label }}
                    </div>
                    <ul v-if="node.children && node.children.length" v-show="node.open">
                        <template v-for="child in node.children">
                            <tree-branch :node="child" :key="child.id" @file-click="handleFileClick"></tree-branch>
                        </template>
                    </ul>
                </li>
            </template>
        </ul>
    </div>
    <div class="right-panel">
        <textarea id="javaCode" v-model="javaCode"></textarea>
    </div>
</div>

<!-- Vue -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.min.js"></script>
<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/xml/xml.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                fileTree: [],
                javaCode: '',
                editor: null
            };
        },
        mounted() {
            this.initEditor();

            // 模拟后端数据
            const response = [
                { path: 'com/example/entity/User.java', content: '// User.java content\npublic class User {}' },
                { path: 'com/example/mapper/UserMapper.java', content: '// Mapper.java content\ninterface UserMapper {}' },
                { path: 'com/example/mapper/UserMapper.xml', content: '<!-- XML content -->\n<mapper></mapper>' }
            ];
            this.fileTree = this.buildTree(response);
        },
        methods: {
            initEditor() {
                this.editor = CodeMirror.fromTextArea(document.getElementById("javaCode"), {
                    mode: "text/x-java",
                    theme: "default",
                    lineNumbers: true,
                    readOnly: true
                });
                this.editor.setSize("100%", "100%");
            },
            toggle(node) {
                if (node.type === 'folder') {
                    node.open = !node.open;
                } else {
                    this.handleFileClick(node);
                }
            },
            handleFileClick(fileNode) {
                this.clearSelection(this.fileTree);
                fileNode.selected = true;
                this.javaCode = fileNode.content;

                const ext = fileNode.label.split('.').pop();
                const mode = ext === 'xml' ? 'application/xml' : 'text/x-java';
                this.editor.setOption("mode", mode);
                this.editor.setValue(fileNode.content);
            },
            clearSelection(nodes) {
                nodes.forEach(node => {
                    node.selected = false;
                    if (node.children) this.clearSelection(node.children);
                });
            },
            buildTree(data) {
                const tree = [];
                const map = {};

                data.forEach(file => {
                    const parts = file.path.split('/');
                    let current = tree;

                    parts.forEach((part, index) => {
                        const pathSoFar = parts.slice(0, index + 1).join('/');
                        if (!map[pathSoFar]) {
                            const isFile = index === parts.length - 1;
                            const node = {
                                id: pathSoFar,
                                label: part,
                                type: isFile ? 'file' : 'folder',
                                open: !isFile,
                                selected: false,
                                children: [],
                                ...(isFile ? { content: file.content } : {})
                            };
                            map[pathSoFar] = node;
                            current.push(node);
                        }
                        current = map[pathSoFar].children;
                    });
                });

                return tree;
            }
        }
    });
</script>

<script>
    // 手动注册 tree-branch，不作为单文件组件，只是渲染子节点（非递归组件）
    Vue.component('tree-branch', {
        props: ['node'],
        methods: {
            toggle(node) {
                if (node.type === 'folder') {
                    node.open = !node.open;
                } else {
                    this.$emit('file-click', node);
                }
            }
        },
        template: `
            <li>
                <div :class="{ selected: node.selected }" @click="toggle(node)">
                    <i :class="node.type === 'folder'
                        ? (node.open ? 'fa-solid fa-folder-open' : 'fa-solid fa-folder')
                        : 'fa-regular fa-file'"></i>
                    {{ node.label }}
                </div>
                <ul v-if="node.children && node.children.length" v-show="node.open">
                    <tree-branch
                        v-for="child in node.children"
                        :key="child.id"
                        :node="child"
                        @file-click="$emit('file-click', $event)"
                    ></tree-branch>
                </ul>
            </li>
        `
    });
</script>
</body>
</html>
